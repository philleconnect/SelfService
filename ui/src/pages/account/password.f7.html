<template>
  <div class="page" data-name="Passwort ändern">
    <p style="font-family: Arial, sans-serif; font-size: 45px;"><b>PASSWORT</b>ÄNDERN</p>
    <h3>Bitte gib hier dein neues Passwort ein:</h3>
    <div class="input-group">
      <input type="password" id="password1" required @input="checkPassword()"/>
      <span class="input-bar"></span>
      <label>Passwort</label>
    </div>
    <p>Aus Sicherheitsgründen muss dein neues Passwort folgende Voraussetzungen erfüllen:</p>
    <div class="standalone-container">
      <i id="length-valid" class="f7-icons standalone-icon nodisplay" style="color: green;">checkmark_circle_fill</i>
      <i id="length-invalid" class="f7-icons standalone-icon" style="color: red;">xmark_circle_fill</i>
      <h4 class="standalone-icon-headline">Mindestens 8 Zeichen.</h4>
    </div>
    <div class="standalone-container">
      <i id="lowercase-valid" class="f7-icons standalone-icon nodisplay" style="color: green;">checkmark_circle_fill</i>
      <i id="lowercase-invalid" class="f7-icons standalone-icon" style="color: red;">xmark_circle_fill</i>
      <h4 class="standalone-icon-headline">Mindestens einen Kleinbuchstaben.</h4>
    </div>
    <div class="standalone-container">
      <i id="uppercase-valid" class="f7-icons standalone-icon nodisplay" style="color: green;">checkmark_circle_fill</i>
      <i id="uppercase-invalid" class="f7-icons standalone-icon" style="color: red;">xmark_circle_fill</i>
      <h4 class="standalone-icon-headline">Mindestens einen Großbuchstaben.</h4>
    </div>
    <div class="standalone-container">
      <i id="number-valid" class="f7-icons standalone-icon nodisplay" style="color: green;">checkmark_circle_fill</i>
      <i id="number-invalid" class="f7-icons standalone-icon" style="color: red;">xmark_circle_fill</i>
      <h4 class="standalone-icon-headline">Mindestens eine Zahl.</h4>
    </div>
    <div class="input-group">
      <input type="password" id="password2" required @input="checkPassword()"/>
      <span class="input-bar"></span>
      <label>Passwort wiederholen</label>
    </div>
    <div id="same" class="standalone-container nodisplay">
      <i class="f7-icons standalone-icon" style="color: green;">checkmark_circle_fill</i><h4 class="standalone-icon-headline">Passwörter stimmen überein.</h4>
    </div>
    <div id="not-same" class="standalone-container nodisplay">
      <i class="f7-icons standalone-icon" style="color: red;">xmark_circle_fill</i><h4 class="standalone-icon-headline">Passwörter stimmen nicht überein.</h4>
    </div>
    <br />
    <button @click="change()">Passwort ändern</button>
  </div>
</template>
<script>
import api from '../../js/api.js';
import Swal from 'sweetalert2';
export default {
  methods: {
    // Check password requirements and equality
    checkPassword: function() {
      if (this.checkEquality()) {
        document.getElementById("same").classList.remove("nodisplay");
        document.getElementById("not-same").classList.add("nodisplay");
      } else {
        document.getElementById("same").classList.add("nodisplay");
        document.getElementById("not-same").classList.remove("nodisplay");
      }
      if (this.check8OrMore()) {
        document.getElementById("length-valid").classList.remove("nodisplay");
        document.getElementById("length-invalid").classList.add("nodisplay");
      } else {
        document.getElementById("length-valid").classList.add("nodisplay");
        document.getElementById("length-invalid").classList.remove("nodisplay");
      }
      if (this.checkLowercase()) {
        document.getElementById("lowercase-valid").classList.remove("nodisplay");
        document.getElementById("lowercase-invalid").classList.add("nodisplay");
      } else {
        document.getElementById("lowercase-valid").classList.add("nodisplay");
        document.getElementById("lowercase-invalid").classList.remove("nodisplay");
      }
      if (this.checkUppercase()) {
        document.getElementById("uppercase-valid").classList.remove("nodisplay");
        document.getElementById("uppercase-invalid").classList.add("nodisplay");
      } else {
        document.getElementById("uppercase-valid").classList.add("nodisplay");
        document.getElementById("uppercase-invalid").classList.remove("nodisplay");
      }
      if (this.checkNumber()) {
        document.getElementById("number-valid").classList.remove("nodisplay");
        document.getElementById("number-invalid").classList.add("nodisplay");
      } else {
        document.getElementById("number-valid").classList.add("nodisplay");
        document.getElementById("number-invalid").classList.remove("nodisplay");
      }
    },
    checkEquality: function() {
      return document.getElementById("password1").value === document.getElementById("password2").value;
    },
    check8OrMore: function() {
      return document.getElementById("password1").value.length >= 8;
    },
    checkLowercase: function() {
      return /[a-z]/.test(document.getElementById("password1").value);
    },
    checkUppercase: function() {
      return /[A-Z]/.test(document.getElementById("password1").value);
    },
    checkNumber: function() {
      return /[0-9]/.test(document.getElementById("password1").value);
    },

    // Change password
    change: function() {
      if (!this.checkEquality()) {
        Swal.fire({
          title: "Die Passwörter stimmen nicht überein.",
          text: "Bitte überprüfe die eingegebenen Passwörter.",
          icon: "warning"
        })
      } else if (!this.check8OrMore() || !this.checkLowercase() || this.checkUppercase() || this.checkNumber()) {
        Swal.fire({
          title: "Dein neues Passwort erfüllt nicht alle Voraussetzungen.",
          text: "Bitte überprüfe dein neues Passwort.",
          icon: "warning"
        })
      } else {
        Swal.fire({
          title: "Passwort wirklich ändern?",
          icon: "question",
          showCancelButton: true,
          confirmButtonText: 'Passwort ändern',
          cancelButtonText: 'Abbrechen',
          confirmButtonColor: '#1155BC',
          preConfirm: function() {
            return new Promise(function(resolve) {
              api.send("/api/user/password", "PUT", {password1: document.getElementById("password1").value, password2: document.getElementById("password2").value}).then(function(response) {
                Swal.fire({
                  title: "Passwort erfolgreich geändert.",
                  text: "Eine erneute Anmeldung ist erforderlich.",
                  icon: "success",
                }).then(function() {
                  api.send("/api/logout", "POST", {}).then(function(response) {
                    window.location.reload();
                  }.bind(this));
                }.bind(this));
              }.bind(this));
            }.bind(this))
          }.bind(this)
        });
      }
    }
  }
};
</script>
